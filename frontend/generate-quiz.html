<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generate Quiz - PopQuiz</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Anton&family=Poppins:wght@300;400;600&display=swap');
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; font-family: 'Poppins', sans-serif; overflow: hidden; }
        .generator-container { display: flex; justify-content: center; align-items: center; flex-direction: column; width: 100%; height: 100%; background-color: #000; color: #fff; position: relative; text-align: center; }
        .grid-background { position: fixed; bottom: 0; left: 0; width: 100%; height: 50%; background-image: linear-gradient(to right, rgba(255, 255, 255, 0.4) 1px, transparent 1px), linear-gradient(to bottom, rgba(255, 255, 255, 0.4) 1px, transparent 1px); background-size: 40px 40px; transform-style: preserve-3d; transform: perspective(500px) rotateX(75deg); z-index: 0; }
        
        /* UPDATED: Consistent Header Styles */
        .header { position: absolute; top: 40px; left: 40px; right: 40px; display: flex; justify-content: space-between; align-items: center; z-index: 2; }
        .logo { font-family: 'Anton', sans-serif; font-size: 1.8rem; font-weight: 400; letter-spacing: 1px; }
        .header-nav { display: flex; align-items: center; gap: 20px; }
        .nav-btn { color: #fff; text-decoration: none; font-weight: 600; border: 2px solid #fff; padding: 8px 15px; border-radius: 50px; transition: all 0.3s ease; font-size: 0.9rem; }
        .nav-btn:hover { background-color: #fff; color: #000; }

        .generator-form { position: relative; z-index: 1; width: 100%; max-width: 450px; padding: 20px; box-sizing: border-box; }
        .generator-form h1 { font-size: 2.5rem; font-weight: 300; letter-spacing: 4px; margin-bottom: 50px; }
        .input-group { position: relative; margin-bottom: 35px; text-align: left; }
        .input-group label { position: absolute; top: -8px; left: 25px; background-color: #000; padding: 0 10px; font-size: 0.8rem; color: #ccc; }
        .input-field { width: 100%; padding: 14px 25px; background-color: transparent; border: 2px solid #fff; border-radius: 50px; color: #fff; font-size: 1rem; box-sizing: border-box; }
        .input-field:-webkit-autofill, .input-field:-webkit-autofill:hover, .input-field:-webkit-autofill:focus, .input-field:-webkit-autofill:active { -webkit-text-fill-color: #fff !important; transition: background-color 5000s ease-in-out 0s; box-shadow: 0 0 0px 1000px #000 inset; }
        select.input-field { -webkit-appearance: none; -moz-appearance: none; appearance: none; background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23FFFFFF%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22/%3E%3C/svg%3E'); background-repeat: no-repeat; background-position: right 25px top 50%; background-size: .65em auto; }
        select.input-field option { background-color: #fff; color: #000; }
        .question-type-group { display: flex; justify-content: space-between; gap: 10px; border: 2px solid #fff; border-radius: 50px; padding: 5px; }
        .type-btn { flex: 1; padding: 10px 5px; background-color: transparent; color: #fff; border: none; border-radius: 50px; cursor: pointer; font-size: 0.9rem; font-weight: 600; font-family: 'Poppins', sans-serif; transition: background-color 0.3s ease; }
        .type-btn.active { background-color: #fff; color: #000; }
        .generate-button { width: 100%; padding: 14px 35px; border: 2px solid #fff; border-radius: 50px; color: #fff; background-color: transparent; text-decoration: none; font-weight: 600; font-size: 1rem; cursor: pointer; transition: all 0.3s ease; margin-top: 20px; }
        .generate-button:hover { background-color: #fff; color: #000; }
    </style>
</head>
<body>
    <div class="generator-container">
        <div class="grid-background"></div>
        <!-- UPDATED: New Header -->
        <header class="header">
            <div class="logo">POPQUIZ</div>
            <div class="header-nav">
                <a href="dashboard.html" class="nav-btn">Dashboard</a>
                <a href="index.html" class="nav-btn">Logout</a>
            </div>
        </header>
        <div class="generator-form">
            <h1>GENERATE NEW QUIZ</h1>
            <form id="quiz-generator-form">
                <div class="input-group"><label for="topic">TOPIC OR SUBJECT</label><input type="text" id="topic" class="input-field" required placeholder="e.g., Process Scheduling, Deadlocks"></div>
                <div class="input-group"><label for="bloom-level">COGNITIVE LEVEL (BLOOM'S)</label><select id="bloom-level" name="bloom-level" class="input-field" required><option value="" disabled selected>Select a cognitive level...</option><option value="Remembering">Remembering (Define, List)</option><option value="Understanding">Understanding (Explain, Summarize)</option><option value="Applying">Applying (Calculate, Solve)</option><option value="Analyzing">Analyzing (Compare, Contrast)</option><option value="Evaluating">Evaluating (Critique, Justify)</option><option value="Creating">Creating (Design, Propose)</option></select></div>
                <div class="input-group"><label for="question-type">QUESTION TYPE</label><div class="question-type-group"><button type="button" class="type-btn active" data-value="Short Answer">Short Answer</button><button type="button" class="type-btn" data-value="MCQ">MCQ</button><button type="button" class="type-btn" data-value="True/False">True/False</button></div><input type="hidden" id="question-type" name="question-type" value="Short Answer"></div>
                <div class="input-group"><label for="num-questions">NUMBER OF QUESTIONS</label><input type="number" id="num-questions" class="input-field" required min="1" placeholder="e.g., 5"></div>
                <button type="submit" class="generate-button">GENERATE QUESTIONS</button>
            </form>
        </div>
    </div>
    <script>
        const typeButtons = document.querySelectorAll('.type-btn'), questionTypeInput = document.getElementById('question-type');
        const API_BASE_URL = 'http://localhost:8000';
        
        // Check authentication on page load - simplified for demo
        let authToken = localStorage.getItem('authToken');
        if (!authToken) {
            // Set a demo token for the interface
            localStorage.setItem('authToken', 'demo-token');
            console.log('Set demo token for interface consistency');
        }
        
        typeButtons.forEach(button => { 
            button.addEventListener('click', () => { 
                typeButtons.forEach(btn => btn.classList.remove('active')); 
                button.classList.add('active'); 
                questionTypeInput.value = button.getAttribute('data-value'); 
            }); 
        });
        
        const quizForm = document.getElementById('quiz-generator-form');
        quizForm.addEventListener('submit', async function(event) {
            event.preventDefault();
            const topic = document.getElementById('topic').value;
            const bloomLevel = document.getElementById('bloom-level').value;
            const questionType = questionTypeInput.value;
            const numQuestions = parseInt(document.getElementById('num-questions').value);
            
            console.log('Form submitted with:', { topic, bloomLevel, questionType, numQuestions });
            
            if (!topic || !bloomLevel || !questionType || !numQuestions) { 
                alert('Please fill in all fields to generate a quiz.'); 
                return; 
            }

            // Show loading state
            const submitBtn = event.target.querySelector('button[type="submit"]');
            const originalText = submitBtn.textContent;
            submitBtn.textContent = 'GENERATING...';
            submitBtn.disabled = true;

            console.log('Making API request to:', `${API_BASE_URL}/test/generate_questions`);

            try {
                const response = await fetch(`${API_BASE_URL}/test/generate_questions`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                        // Using test endpoint, no authentication required
                    },
                    body: JSON.stringify({
                        topic: topic,
                        bloom_level: bloomLevel,
                        question_type: questionType,
                        num_questions: numQuestions
                    })
                });

                console.log('Response status:', response.status);
                const data = await response.json();
                console.log('Response data:', data);

                if (response.ok) {
                    console.log('Questions generated successfully:', data.questions);
                    // Store the generated questions and metadata in localStorage
                    localStorage.setItem('generatedQuestions', JSON.stringify(data.questions));
                    localStorage.setItem('quizMetadata', JSON.stringify({
                        topic, bloomLevel, questionType, numQuestions
                    }));
                    
                    console.log('Redirecting to display-questions.html');
                    window.location.href = 'display-questions.html';
                } else {
                    console.error('API request failed:', response.status, data);
                    alert(data.detail || 'Failed to generate questions. Please try again.');
                }
            } catch (error) {
                console.error('Generation error:', error);
                alert('Network error. Please check if the server is running. The app will use demo questions for now.');
                
                // Fallback to demo questions on the frontend side as well
                const demoQuestions = generateDemoQuestions(topic, questionType, numQuestions);
                localStorage.setItem('generatedQuestions', JSON.stringify(demoQuestions));
                localStorage.setItem('quizMetadata', JSON.stringify({
                    topic, bloomLevel, questionType, numQuestions
                }));
                window.location.href = 'display-questions.html';
            } finally {
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
            }
        });
        
        // Demo questions generator for fallback
        function generateDemoQuestions(topic, questionType, numQuestions) {
            const questions = [];
            
            if (questionType === 'Short Answer') {
                const templates = [
                    `Define ${topic} and explain its key characteristics.`,
                    `What are the main components of ${topic}?`,
                    `How does ${topic} impact modern computing systems?`,
                    `Compare and contrast different approaches to ${topic}.`,
                    `Explain the advantages and disadvantages of ${topic}.`
                ];
                
                for (let i = 0; i < numQuestions; i++) {
                    questions.push(templates[i % templates.length]);
                }
            } else if (questionType === 'MCQ') {
                for (let i = 0; i < numQuestions; i++) {
                    questions.push(`Q${i+1}. Which of the following best describes ${topic}?
A) Option A related to ${topic}
B) Option B related to ${topic}  
C) Option C related to ${topic}
D) Option D related to ${topic}
Correct Answer: A`);
                }
            } else if (questionType === 'True/False') {
                const statements = [
                    `${topic} is essential for modern computer systems.`,
                    `${topic} has no impact on system performance.`,
                    `Understanding ${topic} is important for B.Tech students.`,
                    `${topic} concepts are only theoretical.`,
                    `${topic} has remained unchanged since its inception.`
                ];
                const answers = ['True', 'False', 'True', 'False', 'False'];
                
                for (let i = 0; i < numQuestions; i++) {
                    const index = i % statements.length;
                    questions.push(`Q${i+1}. ${statements[index]}
Answer: ${answers[index]}`);
                }
            }
            
            return questions;
        }
        
        // Function to create test user and login
        async function createTestUserAndLogin() {
            try {
                // Try to create test user
                const signupResponse = await fetch(`${API_BASE_URL}/auth/signup`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        email: 'test@example.com',
                        password: 'password123'
                    })
                });
                
                // Signup might fail if user already exists, that's okay
                console.log('Signup response:', signupResponse.status);
                
                // Now try to login
                const loginResponse = await fetch(`${API_BASE_URL}/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        email: 'test@example.com',
                        password: 'password123'
                    })
                });
                
                if (loginResponse.ok) {
                    const loginData = await loginResponse.json();
                    localStorage.setItem('authToken', loginData.token);
                    console.log('Test user logged in successfully');
                    alert('Test account created and logged in successfully!');
                } else {
                    throw new Error('Failed to login test user');
                }
            } catch (error) {
                console.error('Error creating test user:', error);
                alert('Failed to create test account. Please use the login page.');
                window.location.href = 'faculty-login.html';
            }
        }
    </script>
</body>
</html>

