<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generate Quiz - PopQuiz</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Anton&family=Poppins:wght@300;400;600&display=swap');
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; font-family: 'Poppins', sans-serif; overflow: hidden; }
        .generator-container { display: flex; justify-content: center; align-items: center; flex-direction: column; width: 100%; height: 100%; background-color: #000; color: #fff; position: relative; text-align: center; }
        .grid-background { position: absolute; bottom: 0; left: 0; width: 100%; height: 50%; background-image: linear-gradient(to right, rgba(255, 255, 255, 0.4) 1px, transparent 1px), linear-gradient(to bottom, rgba(255, 255, 255, 0.4) 1px, transparent 1px); background-size: 40px 40px; transform-style: preserve-3d; transform: perspective(500px) rotateX(75deg); z-index: 0; }
        .header { position: absolute; top: 40px; left: 40px; right: 40px; display: flex; justify-content: space-between; align-items: center; z-index: 2; }
        .logo { font-family: 'Anton', sans-serif; font-size: 1.8rem; font-weight: 400; letter-spacing: 1px; }
        .header-nav { display: flex; align-items: center; gap: 20px; }
        .nav-btn { color: #fff; text-decoration: none; font-weight: 600; border: 2px solid #fff; padding: 8px 15px; border-radius: 50px; transition: all 0.3s ease; font-size: 0.9rem; }
        .nav-btn:hover { background-color: #fff; color: #000; }
        .generator-form { position: relative; z-index: 1; width: 100%; max-width: 450px; padding: 20px; box-sizing: border-box; }
        .generator-form h1 { font-size: 2.5rem; font-weight: 300; letter-spacing: 4px; margin-bottom: 50px; }
        .input-group { position: relative; margin-bottom: 35px; text-align: left; }
        .input-group label { position: absolute; top: -8px; left: 25px; background-color: #000; padding: 0 10px; font-size: 0.8rem; color: #ccc; }
        .input-field { width: 100%; padding: 14px 25px; background-color: transparent; border: 2px solid #fff; border-radius: 50px; color: #fff; font-size: 1rem; box-sizing: border-box; }
        .input-field:-webkit-autofill, .input-field:-webkit-autofill:hover, .input-field:-webkit-autofill:focus, .input-field:-webkit-autofill:active { -webkit-text-fill-color: #fff !important; transition: background-color 5000s ease-in-out 0s; box-shadow: 0 0 0px 1000px #000 inset; }
        select.input-field { -webkit-appearance: none; -moz-appearance: none; appearance: none; background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23FFFFFF%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22/%3E%3C/svg%3E'); background-repeat: no-repeat; background-position: right 25px top 50%; background-size: .65em auto; }
        select.input-field option { background-color: #fff; color: #000; }
        .question-type-group { display: flex; justify-content: space-between; gap: 10px; border: 2px solid #fff; border-radius: 50px; padding: 5px; }
        .type-btn { flex: 1; padding: 10px 5px; background-color: transparent; color: #fff; border: none; border-radius: 50px; cursor: pointer; font-size: 0.9rem; font-weight: 600; font-family: 'Poppins', sans-serif; transition: background-color 0.3s ease; }
        .type-btn.active { background-color: #fff; color: #000; }
        .generate-button { width: 100%; padding: 14px 35px; border: 2px solid #fff; border-radius: 50px; color: #fff; background-color: transparent; text-decoration: none; font-weight: 600; font-size: 1rem; cursor: pointer; transition: all 0.3s ease; margin-top: 20px; }
        .generate-button:hover { background-color: #fff; color: #000; }
    .generate-button[disabled] { opacity: 0.6; cursor: default; }
    /* spinner inside button */
    .btn-spinner { display: inline-block; width: 16px; height: 16px; border: 2px solid rgba(255,255,255,0.2); border-top-color: #fff; border-radius: 50%; margin-right: 10px; vertical-align: middle; animation: spin 0.8s linear infinite; }
    @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div class="generator-container">
        <div class="grid-background"></div>
        <header class="header">
            <div class="logo">POPQUIZ</div>
            <div class="header-nav">
                <a href="dashboard.html" class="nav-btn">Dashboard</a>
                <a href="../index.html" class="nav-btn">Logout</a>
            </div>
        </header>
        <div class="generator-form">
            <h1>GENERATE NEW QUIZ</h1>
            <form id="quiz-generator-form">
                <div class="input-group"><label for="topic">TOPIC OR SUBJECT</label><input type="text" id="topic" class="input-field" required placeholder="e.g., Process Scheduling, Deadlocks"></div>
                <div class="input-group"><label for="bloom-level">COGNITIVE LEVEL (BLOOM'S)</label><select id="bloom-level" name="bloom-level" class="input-field" required><option value="" disabled selected>Select a cognitive level...</option><option value="Remembering">Remembering (Define, List)</option><option value="Understanding">Understanding (Explain, Summarize)</option><option value="Applying">Applying (Calculate, Solve)</option><option value="Analyzing">Analyzing (Compare, Contrast)</option><option value="Evaluating">Evaluating (Critique, Justify)</option><option value="Creating">Creating (Design, Propose)</option></select></div>
                <div class="input-group"><label for="question-type">QUESTION TYPE</label><div class="question-type-group"><button type="button" class="type-btn active" data-value="Short Answer">Short Answer</button><button type="button" class="type-btn" data-value="MCQ">MCQ</button><button type="button" class="type-btn" data-value="True/False">True/False</button></div><input type="hidden" id="question-type" name="question-type" value="Short Answer"></div>
                <div class="input-group"><label for="num-questions">NUMBER OF QUESTIONS</label><input type="number" id="num-questions" class="input-field" required min="1" placeholder="e.g., 5"></div>
                <button type="submit" class="generate-button">GENERATE QUESTIONS</button>
            </form>
        </div>
    </div>
    <script>
        const typeButtons = document.querySelectorAll('.type-btn');
        const questionTypeInput = document.getElementById('question-type');
        typeButtons.forEach(button => {
            button.addEventListener('click', () => {
                typeButtons.forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');
                questionTypeInput.value = button.getAttribute('data-value');
            });
        });
        const quizForm = document.getElementById('quiz-generator-form');
        const generateButton = document.querySelector('.generate-button');
        quizForm.addEventListener('submit', async function(event) {
            event.preventDefault();
            const topic = document.getElementById('topic').value;
            const bloom_level = document.getElementById('bloom-level').value;
            const question_type = document.getElementById('question-type').value;
            const num_questions = parseInt(document.getElementById('num-questions').value || '0', 10);
            if (!topic || !bloom_level || !question_type || !num_questions) {
                alert('Please fill all fields');
                return;
            }

            // UI feedback: disable button and show Generating... with spinner
            const prevHTML = generateButton.innerHTML;
            generateButton.setAttribute('disabled', 'true');
            generateButton.setAttribute('aria-busy', 'true');
            generateButton.innerHTML = `<span class="btn-spinner"></span>Generating...`;
            // force reflow so browser paints changed content before network call
            // eslint-disable-next-line no-unused-expressions
            generateButton.offsetHeight;
            await new Promise(res => setTimeout(res, 120));

            // Use test endpoint (no auth) for local development
            fetch('http://localhost:8000/test/generate_questions', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ topic, bloom_level, question_type, num_questions })
            }).then(r => r.json().then(data => ({ok: r.ok, body: data})))
            .then(result => {
                if (!result.ok) {
                    alert(result.body.detail || 'Question generation failed');
                    // restore UI
                    generateButton.removeAttribute('disabled');
                    generateButton.removeAttribute('aria-busy');
                    generateButton.innerHTML = prevHTML;
                    return;
                }
                // store questions in sessionStorage and open editor
                sessionStorage.setItem('generated_questions', JSON.stringify(result.body.questions || []));
                sessionStorage.setItem('generated_meta', JSON.stringify({ topic, bloom_level, question_type }));
                window.location.href = 'quiz-editor.html';
            }).catch(err => {
                console.error(err);
                alert('Unable to reach backend. Make sure the backend is running at http://localhost:8000');
                // restore UI
                generateButton.removeAttribute('disabled');
                generateButton.removeAttribute('aria-busy');
                generateButton.innerHTML = prevHTML;
            });
        });
    </script>
</body>
</html>
